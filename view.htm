<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>数据结构课设</title>
        <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=6a159ce0aac34e52264dcc63bb7bfeca"></script> 
        <script src="jquery-3.4.1.min.js"></script>
        <script src="greedy.js"></script>
        <style>
            input,
            label {
                vertical-align: middle;
            }

            #box1 {
                width: 1000px;
                height: 1000px;
                position: absolute;
                /*background:url("./bjut.jpg")  no-repeat center center;*/
            }

            #box2 {
                width: 1000px;
                height: 200px;
                position: absolute;
            }

            .line {
                width: 2000px;
                height: 2000px;
            }
        </style>
    </head>

    <body>
        <div><a href="tips.htm">说明文档</a><br></div>
        <div>
            <button id="b2">输入邮箱地址</button><br>
            <div id="div">
                <button id="emailbutton">提交数据</button>
                <button id="addemail">添加邮箱</button> <br>
                邮箱地址<input type="email" name="email"><br>
            </div>
        </div>
        <div>
            <form action="">
                <table>
                    <tr>
                        <th>地点</th>
                        <th>停留时间(单位为分钟)</th>
                    </tr>
                    <tr>
                        <td><input type="checkbox" value="1号楼"> <label for="">1号楼</label> </td>
                        <td> <input type="text"> </td>
                    </tr>
                    <tr>
                        <td><input type="checkbox" value="北工大西门地铁站"> <label for="">北工大西门地铁站</label> </td>
                        <td> <input type="text"> </td>
                    </tr>
                    <tr>
                        <td><input type="checkbox" value="图书馆"> <label for="">图书馆</label></td>
                        <td> <input type="text"> </td>
                    </tr>
                    <tr>
                        <td><input type="checkbox" value="天天餐厅"> <label for="">天天餐厅</label></td>
                        <td> <input type="text"> </td>
                    </tr>
                    <tr>
                        <td><input type="checkbox" value="实训楼"> <label for="">实训楼</label></td>
                        <td> <input type="text"> </td>
                    </tr>
                    <tr>
                        <td><input type="checkbox" value="北工大西门"> <label for="">北工大西门</label> </td>
                        <td> <input type="text"> </td>
                    </tr>
                </table>
                <select name="" id="start">
                    <option value="1号楼">1号楼</option>
                    <option value="北工大西门地铁站">北工大西门地铁站</option>
                    <option value="图书馆">图书馆</option>
                    <option value="天天餐厅">天天餐厅</option>
                    <option value="实训楼">实训楼</option>
                    <option value="北工大西门">北工大西门</option>
                </select>
                <input type="button" value="提交" id="button">
            </form>
        </div>
        <div id="box1">
            <!-- 显示选择地点 -->
            <p></p>
            <div id="box2">
                <ul>

                </ul>
            </div>
        </div>
        <canvas id="mc" class="line"> </canvas>
        <script >

            $(document).ready(function () {

                //画布初始化
                var canvas = document.getElementById('mc')
                var context = canvas.getContext('2d');
                var width = canvas.offsetWidth
                var height = canvas.offsetHeight
                canvas.width = width;
                canvas.height = height;
                //  画布初始化结束

                /*
                context.moveTo(10,10)
                context.lineTo(20,20)
                context.stroke()
                context.moveTo(10,10)
                context.lineTo(200,20)
                context.stroke()
                */
                $("#box2").hide()
                $(":checkbox").parent().next().hide()
                $("#addemail").click(function () {
                    var email = '邮箱地址<input type="email" name="email" ><br>'
                    $("#div").append(email)  //显示输入的邮箱
                })

                //发送邮箱数据到server
                $("#emailbutton").click(function () {
                    var e = $("input[type='email']")
                    var emailList = []
                    for (var i = 0; i < e.length; i++) {
                        emailList.push(e[i].value)
                    }
                    console.log(emailList)
                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        url: "http://localhost:7999/email",
                        data: {
                            email: emailList,
                        }
                    })
                })

                $(":checkbox").click(function () {
                    $(this).parent().next().toggle()

                })
                //计算+显示
                $("#button").click(function () {

                    var staytime = {}

                    $("#box2").children().find('*').remove()
                    $("#box2").show()
                    var start = info[$("#start").val()]
                    console.log(start)
                    var add = [] //选择地点数组
                    var sel = $(":checkbox")

                    for (var i = 0; i < sel.length; i++) {
                        if (sel[i].checked) {
                            add.push(info[sel[i].value])
                            ////获取停留时间
                            var ee = sel[i].parentElement.nextElementSibling.childNodes[1].value
                            staytime[sel[i].value] = ee
                        }
                    }

                    add.sort()
                    $("#box1").children("p").html(add) //设置p的html内容

                    var h = {}//地点映射表
                    for (var i = 0; i < add.length; i++) {
                        h[i] = add[i]
                    }
                    //选择哪个地点的矩阵
                    var inMatrix = new Array(add.length)
                    for (var i = 0; i < inMatrix.length; i++) {
                        var tmp = []
                        for (var j = 0; j < inMatrix.length; j++) {
                            tmp.push(info.matrix[add[i]][add[j]])
                        }
                        inMatrix[i] = tmp
                    }

                    var graph = new Graph()
                    graph.a = inMatrix
                    var res = graph.TSP(start) //最短时间
                    //即用时间表示路径长度
                    console.log(res)    
                    var resM = res
                    var resCost = 0
                    var lastPath = []
                    var pathStr = ""
                    for (var i = 0; i < resM.length; i++) {
                        var e = new Edge()
                        e.a = findKey(info, h[resM[i]["a"]]) //从info中按value找到key
                        e.b = findKey(info, h[resM[i]["b"]])
                        e.cost = resM[i]["w"]
                        lastPath.push(e)
                        pathStr = "停留时间:" + staytime[e.a] + "-->" + e.a + "-->" + e.b + "花费:" + e.cost
                        if( e.cost != undefined) {
                            resCost += e.cost
                        }
                        //显示路径
                        $("#box2").children().append($("<li></li>").text(pathStr))//添加列表到div.ul下
                    }

                    //显示总花费
                    for(const i in staytime) {
                        if( staytime[i]!=""){
                            resCost+= parseInt(staytime[i])
                        }
                    }
                    console.log("Cost=",resCost)
                    $("#box2").children().append($("<li></li>").text(resCost))//添加列表到div.ul下
                })


                $("#div").hide() //初始化时隐藏输入邮箱的位置
                $("#b2").click(function () {
                    $("#div").toggle() //
                })
            })
            var inf = 1000//1000代表无穷大
            //所有信息
            var info = {
                "1号楼": 0,
                "天天餐厅": 1,
                "北工大西门": 2,
                "北工大西门地铁站": 3,
                "图书馆": 4,
                "实训楼": 5,
                "matrix": [
                    [inf, 5, 20, inf, inf, inf],
                    [5, inf, inf, inf, 50, inf],
                    [20, inf, inf, 30, inf, inf],
                    [inf, inf, 30, inf, 10, inf],
                    [inf, 50, inf, 10, inf, 60],
                    [inf, inf, inf, inf, 60, inf]
                ]
            }
            
            
            //map通过值来找到key
            function findKey(obj, value, compare = (a, b) => a === b) {
                return Object.keys(obj).find(k => compare(obj[k], value))
            }
        </script>

    </body>

</html>

